
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="_static/javascripts/modernizr.js"></script>
  
  
  
    <title>Advanced Server Installation &#8212; Netmaker 0.23.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/material.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Integrating OAuth" href="oauth.html" />
    <link rel="prev" title="Advanced Client Installation" href="advanced-client-install.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=indigo data-md-color-accent=light-blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#server-installation" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="index.html" title="Netmaker 0.23.0 documentation"
           class="md-header-nav__button md-logo">
          
            <i class="md-icon">&#xe869</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">Netmaker Docs</span>
          <span class="md-header-nav__topic"> Advanced Server Installation </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder=""Search""
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/gravitl/netmaker/" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Netmaker
  </div>
</a>
          </div>
        </div>
      
      
  
  <script src="_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = ""versions.json"",
        target_loc = "../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="index.html" class="md-tabs__link">Netmaker 0.23.0 documentation</a></li>
          <li class="md-tabs__item"><a href="getting-started.html" class="md-tabs__link">Getting Started</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="index.html" title="Netmaker 0.23.0 documentation" class="md-nav__button md-logo">
      
        <i class="md-icon">&#xe869</i>
      
    </a>
    <a href="index.html"
       title="Netmaker 0.23.0 documentation">Netmaker Docs</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/gravitl/netmaker/" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Netmaker
  </div>
</a>
    </div>
  
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
    
      <a href="about.html" class="md-nav__link">About</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="getting-started.html" class="md-nav__link">Getting Started</a>
      <ul class="md-nav__list"> 
    <li class="md-nav__item">
    
    
      <a href="install.html" class="md-nav__link">Install</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="manual-install.html" class="md-nav__link">Manual Install</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="netclient.html" class="md-nav__link">Netclient</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="advanced-client-install.html" class="md-nav__link">Advanced Client Installation</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    <label class="md-nav__link md-nav__link--active" for="__toc"> Advanced Server Installation </label>
    
      <a href="#" class="md-nav__link md-nav__link--active">Advanced Server Installation</a>
      
        
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">"Contents"</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#server-installation--page-root" class="md-nav__link">Advanced Server Installation</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#system-compatibility" class="md-nav__link">System Compatibility</a>
        </li>
        <li class="md-nav__item"><a href="#server-configuration-reference" class="md-nav__link">Server Configuration Reference</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#variable-description" class="md-nav__link">Variable Description</a>
        </li>
        <li class="md-nav__item"><a href="#config-file-reference" class="md-nav__link">Config File Reference</a>
        </li>
        <li class="md-nav__item"><a href="#compose-file-annotated" class="md-nav__link">Compose File - Annotated</a>
        </li>
        <li class="md-nav__item"><a href="#available-docker-compose-files" class="md-nav__link">Available docker-compose files</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#emqx" class="md-nav__link">EMQX</a>
        </li>
        <li class="md-nav__item"><a href="#linux-install-without-docker" class="md-nav__link">Linux Install without Docker</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#database-setup-optional" class="md-nav__link">Database Setup (optional)</a>
        </li>
        <li class="md-nav__item"><a href="#server-setup-using-sqlite" class="md-nav__link">Server Setup (using sqlite)</a>
        </li>
        <li class="md-nav__item"><a href="#ui-setup" class="md-nav__link">UI Setup</a>
        </li>
        <li class="md-nav__item"><a href="#proxy-http-server" class="md-nav__link">Proxy / Http server</a>
        </li>
        <li class="md-nav__item"><a href="#caddy" class="md-nav__link">Caddy</a>
        </li>
        <li class="md-nav__item"><a href="#mq" class="md-nav__link">MQ</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#kubernetes-install" class="md-nav__link">Kubernetes Install</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#server-install" class="md-nav__link">Server Install</a>
        </li>
        <li class="md-nav__item"><a href="#netclient-daemonset" class="md-nav__link">Netclient Daemonset</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#nginx-reverse-proxy-setup-with-https" class="md-nav__link">Nginx Reverse Proxy Setup with https</a>
        </li>
        <li class="md-nav__item"><a href="#nginx-proxy-manager-setup" class="md-nav__link">Nginx Proxy Manager Setup</a>
        </li>
        <li class="md-nav__item"><a href="#highly-available-installation-kubernetes" class="md-nav__link">Highly Available Installation (Kubernetes)</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#requirements" class="md-nav__link">Requirements</a>
        </li>
        <li class="md-nav__item"><a href="#recommended-settings" class="md-nav__link">Recommended Settings:</a>
        </li>
        <li class="md-nav__item"><a href="#example-installations" class="md-nav__link">Example Installations:</a>
        </li>
        <li class="md-nav__item"><a href="#ingress" class="md-nav__link">Ingress</a>
        </li>
        <li class="md-nav__item"><a href="#kernel-wireguard" class="md-nav__link">Kernel WireGuard</a>
        </li>
        <li class="md-nav__item"><a href="#dns" class="md-nav__link">DNS</a>
        </li>
        <li class="md-nav__item"><a href="#values" class="md-nav__link">Values</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#highly-available-installation-vms-bare-metal" class="md-nav__link">Highly Available Installation (VMs/Bare Metal)</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#load-balancer-setup" class="md-nav__link">1. Load Balancer Setup</a>
        </li>
        <li class="md-nav__item"><a href="#rqlite-setup" class="md-nav__link">2. rqlite Setup</a>
        </li>
        <li class="md-nav__item"><a href="#netmaker-setup" class="md-nav__link">3. Netmaker Setup</a>
        </li>
        <li class="md-nav__item"><a href="#other-considerations" class="md-nav__link">4. Other Considerations</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#security-settings" class="md-nav__link">Security Settings</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#for-caddy" class="md-nav__link">For Caddy</a>
        </li>
        <li class="md-nav__item"><a href="#for-traefik" class="md-nav__link">For Traefik</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
  </ul>
</nav>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="oauth.html" class="md-nav__link">Integrating OAuth</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="getting-started.html#setup" class="md-nav__link">Setup</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="getting-started.html#create-a-network" class="md-nav__link">Create a Network</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="getting-started.html#create-a-key" class="md-nav__link">Create a Key</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="getting-started.html#deploy-nodes" class="md-nav__link">Deploy Nodes</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="getting-started.html#manage-nodes-hosts" class="md-nav__link">Manage Nodes/Hosts</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="getting-started.html#uninstalling-the-netclient" class="md-nav__link">Uninstalling the netclient</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="getting-started.html#uninstalling-netmaker" class="md-nav__link">Uninstalling Netmaker</a>
      
    
    </li></ul>
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="features.html" class="md-nav__link">Features</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="upgrades.html" class="md-nav__link">Upgrades</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="how-to-guides.html" class="md-nav__link">How-to-Guides</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="references.html" class="md-nav__link">References</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="license.html" class="md-nav__link">License</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="conduct.html" class="md-nav__link">Code of Conduct</a>
      
    
    </li>
  </ul>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">"Contents"</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#server-installation--page-root" class="md-nav__link">Advanced Server Installation</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#system-compatibility" class="md-nav__link">System Compatibility</a>
        </li>
        <li class="md-nav__item"><a href="#server-configuration-reference" class="md-nav__link">Server Configuration Reference</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#variable-description" class="md-nav__link">Variable Description</a>
        </li>
        <li class="md-nav__item"><a href="#config-file-reference" class="md-nav__link">Config File Reference</a>
        </li>
        <li class="md-nav__item"><a href="#compose-file-annotated" class="md-nav__link">Compose File - Annotated</a>
        </li>
        <li class="md-nav__item"><a href="#available-docker-compose-files" class="md-nav__link">Available docker-compose files</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#emqx" class="md-nav__link">EMQX</a>
        </li>
        <li class="md-nav__item"><a href="#linux-install-without-docker" class="md-nav__link">Linux Install without Docker</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#database-setup-optional" class="md-nav__link">Database Setup (optional)</a>
        </li>
        <li class="md-nav__item"><a href="#server-setup-using-sqlite" class="md-nav__link">Server Setup (using sqlite)</a>
        </li>
        <li class="md-nav__item"><a href="#ui-setup" class="md-nav__link">UI Setup</a>
        </li>
        <li class="md-nav__item"><a href="#proxy-http-server" class="md-nav__link">Proxy / Http server</a>
        </li>
        <li class="md-nav__item"><a href="#caddy" class="md-nav__link">Caddy</a>
        </li>
        <li class="md-nav__item"><a href="#mq" class="md-nav__link">MQ</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#kubernetes-install" class="md-nav__link">Kubernetes Install</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#server-install" class="md-nav__link">Server Install</a>
        </li>
        <li class="md-nav__item"><a href="#netclient-daemonset" class="md-nav__link">Netclient Daemonset</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#nginx-reverse-proxy-setup-with-https" class="md-nav__link">Nginx Reverse Proxy Setup with https</a>
        </li>
        <li class="md-nav__item"><a href="#nginx-proxy-manager-setup" class="md-nav__link">Nginx Proxy Manager Setup</a>
        </li>
        <li class="md-nav__item"><a href="#highly-available-installation-kubernetes" class="md-nav__link">Highly Available Installation (Kubernetes)</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#requirements" class="md-nav__link">Requirements</a>
        </li>
        <li class="md-nav__item"><a href="#recommended-settings" class="md-nav__link">Recommended Settings:</a>
        </li>
        <li class="md-nav__item"><a href="#example-installations" class="md-nav__link">Example Installations:</a>
        </li>
        <li class="md-nav__item"><a href="#ingress" class="md-nav__link">Ingress</a>
        </li>
        <li class="md-nav__item"><a href="#kernel-wireguard" class="md-nav__link">Kernel WireGuard</a>
        </li>
        <li class="md-nav__item"><a href="#dns" class="md-nav__link">DNS</a>
        </li>
        <li class="md-nav__item"><a href="#values" class="md-nav__link">Values</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#highly-available-installation-vms-bare-metal" class="md-nav__link">Highly Available Installation (VMs/Bare Metal)</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#load-balancer-setup" class="md-nav__link">1. Load Balancer Setup</a>
        </li>
        <li class="md-nav__item"><a href="#rqlite-setup" class="md-nav__link">2. rqlite Setup</a>
        </li>
        <li class="md-nav__item"><a href="#netmaker-setup" class="md-nav__link">3. Netmaker Setup</a>
        </li>
        <li class="md-nav__item"><a href="#other-considerations" class="md-nav__link">4. Other Considerations</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#security-settings" class="md-nav__link">Security Settings</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#for-caddy" class="md-nav__link">For Caddy</a>
        </li>
        <li class="md-nav__item"><a href="#for-traefik" class="md-nav__link">For Traefik</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <section id="advanced-server-installation">
<h1 id="server-installation--page-root">Advanced Server Installation<a class="headerlink" href="#server-installation--page-root" title="Permalink to this headline">¶</a></h1>
<p>This section outlines installing the Netmaker server, including Netmaker, Netmaker UI, rqlite, and CoreDNS.</p>
<section id="system-compatibility">
<h2 id="system-compatibility">System Compatibility<a class="headerlink" href="#system-compatibility" title="Permalink to this headline">¶</a></h2>
<p>Netmaker requires elevated privileges on the host machine to perform network operations. Netmaker must be able to modify interfaces and set firewall rules using iptables.</p>
<p>Typically, Netmaker is run inside of containers, using Docker or Kubernetes.</p>
<p>Netmaker can be run without containers, but this is not recommended. You must run the Netmaker binary, CoreDNS binary, database, and a web server directly on the host.</p>
<p>Each of these components has its own individual requirements and the management complexity increases exponentially by running outside of containers.</p>
<p>For first-time installs, we recommend the quick install guide. The following documents are meant for more advanced installation environments and are not recommended for most users. However, these documents can be helpful in customizing or troubleshooting your own installation.</p>
</section>
<section id="server-configuration-reference">
<span id="id1"></span><h2 id="server-configuration-reference">Server Configuration Reference<a class="headerlink" href="#server-configuration-reference" title="Permalink to this headline">¶</a></h2>
<p>Netmaker sets its configuration in the following order of precedence:</p>
<ol class="arabic simple">
<li><p><strong>Environment Variables:</strong> Typically values set in the Docker Compose. This is the most common way of setting server values.</p></li>
<li><p><strong>Config File:</strong> Values set in the <code class="docutils literal notranslate"><span class="pre">config/environments/*.yaml</span></code> file.</p></li>
<li><p><strong>Defaults:</strong> Default values set on the server if no value is provided in configuration.</p></li>
</ol>
<p>In most situations, if you wish to modify a server setting, set it in the netmaker.env file, then run “docker kill netmaker” and “docker-compose up -d”.</p>
<section id="variable-description">
<h3 id="variable-description">Variable Description<a class="headerlink" href="#variable-description" title="Permalink to this headline">¶</a></h3>
<dl>
<dt>SERVER_NAME</dt><dd><p><strong>Default:</strong> “”</p>
<p><strong>Description:</strong>  MUST SET THIS VALUE. This is the public, resolvable DNS name of the MQ Broker. For instance: broker.netmaker.example.com.</p>
</dd>
<dt>SERVER_HOST</dt><dd><p><strong>Default:</strong> (Server detects the public IP address of machine)</p>
<p><strong>Description:</strong> The public IP of the server where the machine is running.</p>
</dd>
<dt>SERVER_API_CONN_STRING</dt><dd><p><strong>Default:</strong> “”</p>
<p><strong>Description:</strong>  MUST SET THIS VALUE. This is the public, resolvable address of the API, including the port. For instance: api.netmaker.example.com:443.</p>
</dd>
<dt>COREDNS_ADDR</dt><dd><p><strong>Default:</strong> “”</p>
<p><strong>Description:</strong> The public IP of the CoreDNS server. Will typically be the same as the server where Netmaker is running (same as SERVER_HOST).</p>
</dd>
<dt>SERVER_HTTP_HOST</dt><dd><p><strong>Default:</strong> Equals SERVER_HOST if set, “127.0.0.1” if SERVER_HOST is unset.</p>
<p><strong>Description:</strong> Should be the same as SERVER_API_CONN_STRING minus the port.</p>
</dd>
<dt>API_PORT:</dt><dd><p><strong>Default:</strong> 8081</p>
<p><strong>Description:</strong> Should be the same as the port on SERVER_API_CONN_STRING in most cases. Sets the port for the API on the server.</p>
</dd>
<dt>MASTER_KEY:</dt><dd><p><strong>Default:</strong> “secretkey”</p>
<p><strong>Description:</strong> The admin master key for accessing the API. Change this in any production installation.</p>
</dd>
<dt>CORS_ALLOWED_ORIGIN:</dt><dd><p><strong>Default:</strong> “*”</p>
<p><strong>Description:</strong> The “allowed origin” for API requests. Change to restrict where API requests can come from.</p>
</dd>
<dt>REST_BACKEND:</dt><dd><p><strong>Default:</strong> “on”</p>
<p><strong>Description:</strong> Enables the REST backend (API running on API_PORT at SERVER_HTTP_HOST). Change to “off” to turn off.</p>
</dd>
<dt>DNS_MODE:</dt><dd><p><strong>Default:</strong> “off”</p>
<p><strong>Description:</strong> Enables DNS Mode, meaning config files will be generated for CoreDNS.</p>
</dd>
<dt>DATABASE:</dt><dd><p><strong>Default:</strong> “sqlite”</p>
<p><strong>Description:</strong> Specify db type to connect with. Currently, options include “sqlite”, “rqlite”, and “postgres”.</p>
</dd>
<dt>SQL_CONN:</dt><dd><p><strong>Default:</strong> “<a class="reference external" href="http://">http://</a>”</p>
<p><strong>Description:</strong> Specify the necessary string to connect with your local or remote sql database.</p>
</dd>
<dt>SQL_HOST:</dt><dd><p><strong>Default:</strong> “localhost”</p>
<p><strong>Description:</strong> Host where postgres is running.</p>
</dd>
<dt>SQL_PORT:</dt><dd><p><strong>Default:</strong> “5432”</p>
<p><strong>Description:</strong> port postgres is running.</p>
</dd>
<dt>SQL_DB:</dt><dd><p><strong>Default:</strong> “netmaker”</p>
<p><strong>Description:</strong> DB to use in postgres.</p>
</dd>
<dt>SQL_USER:</dt><dd><p><strong>Default:</strong> “postgres”</p>
<p><strong>Description:</strong> User for postgres.</p>
</dd>
<dt>SQL_PASS:</dt><dd><p><strong>Default:</strong> “nopass”</p>
<p><strong>Description:</strong> Password for postgres.</p>
</dd>
<dt>RCE:</dt><dd><p><strong>Default:</strong> “off”</p>
<p><strong>Description:</strong> The server enables you to set PostUp and PostDown commands for nodes, which is standard for WireGuard with wg-quick, but is also <strong>Remote Code Execution</strong>, which is a critical vulnerability if the server is exploited. Because of this, it’s turned off by default, but if turned on, PostUp and PostDown become editable.</p>
</dd>
<dt>DISPLAY_KEYS</dt><dd><p><strong>Default:</strong> “on”</p>
<p><strong>Description:</strong> If “on”, will allow you to always show the key values of “access keys”. This could be considered a vulnerability, so if turned “off”, will only display key values once, and it is up to the users to store the key values locally.</p>
</dd>
<dt>NODE_ID</dt><dd><p><strong>Default:</strong> &lt;system mac addres&gt;</p>
<p><strong>Description:</strong> This setting is used for HA configurations of the server, to identify between different servers. Nodes are given ID’s like netmaker-1, netmaker-2, and netmaker-3. If the server is not HA, there is no reason to set this field.</p>
</dd>
<dt>TELEMETRY</dt><dd><p><strong>Default:</strong> “on”</p>
<p><strong>Description:</strong> If “on”, the server will send anonymous telemetry data once daily, which is used to improve the product. Data sent includes counts (integer values) for the number of nodes, types of nodes, users, and networks. It also sends the version of the server.</p>
</dd>
<dt>MQ_HOST</dt><dd><p><strong>Default:</strong> (public IP of server)</p>
<p><strong>Description:</strong> The address of the mq server. If running from docker compose it will be “mq”. If using “host networking”, it will find and detect the IP of the mq container. Otherwise, need to input address. If not set, it will use the public IP of the server. The port 1883 will be appended automatically. This is the expected reachable port for MQ and cannot be changed at this time.</p>
</dd>
<dt>HOST_NETWORK:</dt><dd><p><strong>Default:</strong> “off”</p>
<p><strong>Description:</strong> Whether or not host networking is turned on. Only turn on if configured for host networking (see docker-compose.hostnetwork.yml). Will set host-level settings like iptables and forwarding for MQ.</p>
</dd>
<dt>MANAGE_IPTABLES:</dt><dd><p><strong>Default:</strong> “on”</p>
<p><strong>Description:</strong> # Allows netmaker to manage iptables locally to set forwarding rules. Largely for DNS or SSH forwarding (see below). It will also set a default “allow forwarding” policy on the host. It’s better to leave this on unless you know what you’re doing.</p>
</dd>
<dt>PORT_FORWARD_SERVICES:</dt><dd><p><strong>Default:</strong> “”</p>
<p><strong>Description:</strong> Comma-separated list of services for which to configure port forwarding on the machine. Options include “mq,dns,ssh”. MQ IS DEPRECIATED, DO NOT SET THIS.’ssh’ forwards port 22 over WireGuard, enabling ssh to server over WireGuard. However, if you set the Netmaker server as an Remote Access Gateway (ingress), this will break SSH on Remote Access Clients, so be careful. DNS enables private DNS over WireGuard. If you would like to use private DNS with ext clients, turn this on.</p>
</dd>
<dt>VERBOSITY:</dt><dd><p><strong>Default:</strong> 0</p>
<p><strong>Description:</strong> Specify the level of logging you would like on the server. Goes up to 3 for debugging. If you run into issues, up the verbosity.</p>
</dd>
</dl>
</section>
<section id="config-file-reference">
<h3 id="config-file-reference">Config File Reference<a class="headerlink" href="#config-file-reference" title="Permalink to this headline">¶</a></h3>
<p>A config file may be placed under config/environments/&lt;env-name&gt;.yml. To read this file at runtime, provide the environment variable NETMAKER_ENV at runtime. For instance, dev.yml paired with ENV=dev. Netmaker will load the specified Config file. This allows you to store and manage configurations for different environments. Below is a reference Config File you may use.</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">server</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">apihost</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to 127.0.0.1 or remote ip (SERVER_HOST) if DisableRemoteIPCheck is not set to true. SERVER_API_HOST if set</span><span class="w"></span>
<span class="w">  </span><span class="nt">apiport</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to 8081 or HTTP_PORT (if set)</span><span class="w"></span>
<span class="w">  </span><span class="nt">masterkey</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to 'secretkey' or MASTER_KEY (if set)</span><span class="w"></span>
<span class="w">  </span><span class="nt">allowedorigin</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to '*' or CORS_ALLOWED_ORIGIN (if set)</span><span class="w"></span>
<span class="w">  </span><span class="nt">restbackend</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to "on" or REST_BACKEND (if set)</span><span class="w"></span>
<span class="w">  </span><span class="nt">clientmode</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to "on" or CLIENT_MODE (if set)</span><span class="w"></span>
<span class="w">  </span><span class="nt">dnsmode</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to "on" or DNS_MODE (if set)</span><span class="w"></span>
<span class="w">  </span><span class="nt">sqlconn</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to "http://" or SQL_CONN (if set)</span><span class="w"></span>
<span class="w">  </span><span class="nt">disableremoteipcheck</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to "false" or DISABLE_REMOTE_IP_CHECK (if set)</span><span class="w"></span>
<span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># version of server</span><span class="w"></span>
<span class="w">  </span><span class="nt">rce</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to "off"</span><span class="w"></span>
<span class="w">  </span><span class="nt">mqhost</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to "mq"</span><span class="w"></span>
<span class="w">  </span><span class="nt">nodeid</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to macaddress of machine</span><span class="w"></span>
<span class="w">  </span><span class="nt">messagequeuebackend</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># default to "on"</span><span class="w"></span>
<span class="w">  </span><span class="nt">database</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to "sqlite"</span><span class="w"></span>
<span class="w">  </span><span class="nt">verbosity</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to 0</span><span class="w"></span>
<span class="w">  </span><span class="nt">authprovider</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to ""</span><span class="w"></span>
<span class="w">  </span><span class="nt">displaykeys</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1">#  defaults to "on"</span><span class="w"></span>
<span class="w">  </span><span class="nt">manageiptables</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to "on"</span><span class="w"></span>
<span class="w">  </span><span class="nt">portforwardservices</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to "", options include "dns" and "ssh"</span><span class="w"></span>
<span class="w">  </span><span class="nt">hostnetwork</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to "off"</span><span class="w"></span>
<span class="w">  </span><span class="nt">mqport</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to 8883</span><span class="w"></span>
<span class="w">  </span><span class="nt">mqserverport</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to 1883</span><span class="w"></span>
<span class="w">  </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="c1"># defaults to "", should be broker domain</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="compose-file-annotated">
<h3 id="compose-file-annotated">Compose File - Annotated<a class="headerlink" href="#compose-file-annotated" title="Permalink to this headline">¶</a></h3>
<p>All environment variables and options are enabled in this file. It is the equivalent to running the “full install” from the above section. However, all environment variables are included and are set to the default values provided by Netmaker (if the environment variable was left unset, it would not change the installation). Comments are added to each option to show how you might use it to modify your installation.</p>
<p>As of v0.18.0, netmaker now uses a stun server (Session Traversal Utilities for NAT). This provides a tool for communications protocols to detect and traverse NATs that are located in the path between two endpoints. By default, netmaker uses publicly available STUN servers.  You are free to set up your own stun severs and use those to augment/replace the public STUN servers. Update the STUN_LIST to list the STUN servers you wish to use. Two resources for installing your own STUN server are:</p>
<p><a class="reference external" href="https://ourcodeworld.com/articles/read/1175/how-to-create-and-configure-your-own-stun-turn-server-with-coturn-in-ubuntu-18-04">https://ourcodeworld.com/articles/read/1175/how-to-create-and-configure-your-own-stun-turn-server-with-coturn-in-ubuntu-18-04</a></p>
<p><a class="reference external" href="https://cloudkul.com/blog/how-to-install-turn-stun-server-on-aws-ubuntu-20-04/">https://cloudkul.com/blog/how-to-install-turn-stun-server-on-aws-ubuntu-20-04/</a></p>
<p>There are also some environment variables that have been changed, or removed. Your updated docker-compose and .env files should look like this.</p>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">"3.4"</span><span class="w"></span>

<span class="nt">services</span><span class="p">:</span><span class="w"></span>

<span class="w">  </span><span class="nt">netmaker</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netmaker</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gravitl/netmaker:$SERVER_IMAGE_TAG</span><span class="w"></span>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./netmaker.env</span><span class="w"></span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span><span class="w"></span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dnsconfig:/root/config/dnsconfig</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sqldata:/root/data</span><span class="w"></span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="c1"># config-dependant vars</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">STUN_LIST=stun1.netmaker.io:3478,stun2.netmaker.io:3478,stun1.l.google.com:19302,stun2.l.google.com:19302</span><span class="w"></span>
<span class="w">      </span><span class="c1"># The domain/host IP indicating the mq broker address</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BROKER_ENDPOINT=wss://broker.${NM_DOMAIN}</span><span class="w"></span>
<span class="w">      </span><span class="c1"># The base domain of netmaker</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SERVER_NAME=${NM_DOMAIN}</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SERVER_API_CONN_STRING=api.${NM_DOMAIN}:443</span><span class="w"></span>
<span class="w">      </span><span class="c1"># Address of the CoreDNS server. Defaults to SERVER_HOST</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">COREDNS_ADDR=${SERVER_HOST}</span><span class="w"></span>
<span class="w">      </span><span class="c1"># Overrides SERVER_HOST if set. Useful for making HTTP available via different interfaces/networks.</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">SERVER_HTTP_HOST=api.${NM_DOMAIN}</span><span class="w"></span>

<span class="w">  </span><span class="nt">netmaker-ui</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netmaker-ui</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gravitl/netmaker-ui:$UI_IMAGE_TAG</span><span class="w"></span>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./netmaker.env</span><span class="w"></span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="c1"># config-dependant vars</span><span class="w"></span>
<span class="w">      </span><span class="c1"># URL where UI will send API requests. Change based on SERVER_HOST, SERVER_HTTP_HOST, and API_PORT</span><span class="w"></span>
<span class="w">      </span><span class="nt">BACKEND_URL</span><span class="p">:</span><span class="w"> </span><span class="s">"https://api.${NM_DOMAIN}"</span><span class="w"></span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netmaker</span><span class="w"></span>
<span class="w">    </span><span class="nt">links</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"netmaker:api"</span><span class="w"></span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span><span class="w"></span>

<span class="w">  </span><span class="nt">caddy</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">caddy:2.6.2</span><span class="w"></span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">caddy</span><span class="w"></span>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./netmaker.env</span><span class="w"></span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span><span class="w"></span>
<span class="w">    </span><span class="nt">extra_hosts</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"host.docker.internal:host-gateway"</span><span class="w"></span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./Caddyfile:/etc/caddy/Caddyfile</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./certs:/root/certs</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">caddy_data:/data</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">caddy_conf:/config</span><span class="w"></span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"80:80"</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"443:443"</span><span class="w"></span>

<span class="w">  </span><span class="nt">coredns</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">coredns</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">coredns/coredns</span><span class="w"></span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">-conf /root/dnsconfig/Corefile</span><span class="w"></span>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./netmaker.env</span><span class="w"></span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netmaker</span><span class="w"></span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span><span class="w"></span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dnsconfig:/root/dnsconfig</span><span class="w"></span>
<span class="w">  </span><span class="nt">mq</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mq</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">eclipse-mosquitto:2.0.15-openssl</span><span class="w"></span>
<span class="w">    </span><span class="nt">env_file</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./netmaker.env</span><span class="w"></span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netmaker</span><span class="w"></span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span><span class="w"></span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="w"> </span><span class="s">"/mosquitto/config/wait.sh"</span><span class="w"> </span><span class="p p-Indicator">]</span><span class="w"></span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./mosquitto.conf:/mosquitto/config/mosquitto.conf</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./wait.sh:/mosquitto/config/wait.sh</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mosquitto_logs:/mosquitto/log</span><span class="w"></span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mosquitto_data:/mosquitto/data</span><span class="w"></span>

<span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">caddy_data</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="p p-Indicator">}</span><span class="w"> </span><span class="c1"># runtime data for caddy</span><span class="w"></span>
<span class="w">  </span><span class="nt">caddy_conf</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="p p-Indicator">}</span><span class="w"> </span><span class="c1"># configuration file for Caddy</span><span class="w"></span>
<span class="w">  </span><span class="nt">sqldata</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="p p-Indicator">}</span><span class="w"></span>
<span class="w">  </span><span class="nt">dnsconfig</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="p p-Indicator">}</span><span class="w"> </span><span class="c1"># storage for coredns</span><span class="w"></span>
<span class="w">  </span><span class="nt">mosquitto_logs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="p p-Indicator">}</span><span class="w"> </span><span class="c1"># storage for mqtt logs</span><span class="w"></span>
<span class="w">  </span><span class="nt">mosquitto_data</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="w"> </span><span class="p p-Indicator">}</span><span class="w"> </span><span class="c1"># storage for mqtt data</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-YAML notranslate"><div class="highlight"><pre><span></span><span class="c1"># Email used for SSL certificates</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">NM_EMAIL=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># The base domain of netmaker</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">NM_DOMAIN=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># Public IP of machine</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">SERVER_HOST=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># The admin master key for accessing the API. Change this in any production installation.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">MASTER_KEY=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># The username to set for MQ access</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">MQ_USERNAME=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># The password to set for MQ access</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">MQ_PASSWORD=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">INSTALL_TYPE=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">NETMAKER_TENANT_ID=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">LICENSE_KEY=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">SERVER_IMAGE_TAG=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">UI_IMAGE_TAG=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">NETCLIENT_ENDPOINT_DETECTION="disabled"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># used for HA - identifies this server vs other servers</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">NODE_ID="netmaker-server-1"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">METRICS_EXPORTER="off"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">PROMETHEUS="off"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># Enables DNS Mode, meaning all nodes will set hosts file for private dns settings</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">DNS_MODE="on"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># Enable auto update of netclient ? ENUM:- enabled,disabled | default=enabled</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">NETCLIENT_AUTO_UPDATE="enabled"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># The HTTP API port for Netmaker. Used for API calls / communication from front end.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># If changed, need to change port of BACKEND_URL for netmaker-ui.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">API_PORT="8081"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">EXPORTER_API_PORT="8085"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># The "allowed origin" for API requests. Change to restrict where API requests can come from with comma-separated</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># URLs. ex:- https://dashboard.netmaker.domain1.com,https://dashboard.netmaker.domain2.com</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">CORS_ALLOWED_ORIGIN="*"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># Show keys permanently in UI (until deleted) as opposed to 1-time display.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">DISPLAY_KEYS="on"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># Database to use - sqlite, postgres, or rqlite</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">DATABASE="sqlite"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># The address of the mq server. If running from docker compose it will be "mq". Otherwise, need to input address.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># If using "host networking", it will find and detect the IP of the mq container.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">SERVER_BROKER_ENDPOINT="ws://mq:1883"</span><span class="w"> </span><span class="c1"># For EMQX websockets use `SERVER_BROKER_ENDPOINT=ws://mq:8083/mqtt`</span><span class="w"></span>
<span class="c1"># The reachable port of STUN on the server</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">STUN_PORT="3478"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># Logging verbosity level - 1, 2, or 3</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">VERBOSITY="1"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">DEBUG_MODE="off"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># Enables the REST backend (API running on API_PORT at SERVER_HTTP_HOST).</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># Change to "off" to turn off.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">REST_BACKEND="on"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># If turned "on", Server will not set Host based on remote IP check.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># This is already overridden if SERVER_HOST is set. Turned "off" by default.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">DISABLE_REMOTE_IP_CHECK="off"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># Whether or not to send telemetry data to help improve Netmaker. Switch to "off" to opt out of sending telemetry.</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">TELEMETRY="on"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">###</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">#</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># OAuth section</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">#</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">###</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># "&lt;azure-ad|github|google|oidc&gt;"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">AUTH_PROVIDER=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># "&lt;client id of your oauth provider&gt;"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">CLIENT_ID=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># "&lt;client secret of your oauth provider&gt;"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">CLIENT_SECRET=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># "https://dashboard.&lt;netmaker base domain&gt;"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">FRONTEND_URL=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># "&lt;only for azure, you may optionally specify the tenant for the OAuth&gt;"</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">AZURE_TENANT=</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain"># https://oidc.yourprovider.com - URL of oidc provider</span><span class="w"></span>
<span class="l l-Scalar l-Scalar-Plain">OIDC_ISSUER=</span><span class="w"></span>
</pre></div>
</div>
<p>Your Caddyfile should look like this.</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="na">{</span><span class="w"></span>

<span class="w">    </span><span class="na">email YOUR_EMAIL</span><span class="w"></span>
<span class="na">}</span><span class="w"></span>

<span class="c1"># Dashboard</span><span class="w"></span>
<span class="na">https://dashboard.NETMAKER_BASE_DOMAIN {</span><span class="w"></span>
<span class="w">    </span><span class="c1"># Apply basic security headers</span><span class="w"></span>
<span class="w">    </span><span class="na">header {</span><span class="w"></span>
<span class="w">            </span><span class="c1"># Enable cross origin access to *.NETMAKER_BASE_DOMAIN</span><span class="w"></span>
<span class="w">            </span><span class="na">Access-Control-Allow-Origin *.NETMAKER_BASE_DOMAIN</span><span class="w"></span>
<span class="w">            </span><span class="c1"># Enable HTTP Strict Transport Security (HSTS)</span><span class="w"></span>
<span class="w">            </span><span class="na">Strict-Transport-Security "max-age</span><span class="o">=</span><span class="s">31536000;"</span><span class="w"></span>
<span class="w">            </span><span class="c1"># Enable cross-site filter (XSS) and tell browser to block detected attacks</span><span class="w"></span>
<span class="w">            </span><span class="na">X-XSS-Protection "1; mode</span><span class="o">=</span><span class="s">block"</span><span class="w"></span>
<span class="w">            </span><span class="c1"># Disallow the site to be rendered within a frame on a foreign domain (clickjacking protection)</span><span class="w"></span>
<span class="w">            </span><span class="na">X-Frame-Options "SAMEORIGIN"</span><span class="w"></span>
<span class="w">            </span><span class="c1"># Prevent search engines from indexing</span><span class="w"></span>
<span class="w">            </span><span class="na">X-Robots-Tag "none"</span><span class="w"></span>
<span class="w">            </span><span class="c1"># Remove the server name</span><span class="w"></span>
<span class="w">            </span><span class="na">-Server</span><span class="w"></span>
<span class="w">    </span><span class="na">}</span><span class="w"></span>

<span class="w">    </span><span class="na">reverse_proxy http://netmaker-ui</span><span class="w"></span>
<span class="na">}</span><span class="w"></span>

<span class="c1"># API</span><span class="w"></span>
<span class="na">https://api.NETMAKER_BASE_DOMAIN {</span><span class="w"></span>
<span class="w">        </span><span class="na">reverse_proxy http://netmaker:8081</span><span class="w"></span>
<span class="na">}</span><span class="w"></span>

<span class="c1"># MQ</span><span class="w"></span>
<span class="na">wss://broker.NETMAKER_BASE_DOMAIN {</span><span class="w"></span>
<span class="w">        </span><span class="na">reverse_proxy ws://mq:8883</span><span class="w"></span>
<span class="na">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="available-docker-compose-files">
<h3 id="available-docker-compose-files">Available docker-compose files<a class="headerlink" href="#available-docker-compose-files" title="Permalink to this headline">¶</a></h3>
<p>The default options for docker-compose can be found here: <a class="reference external" href="https://github.com/gravitl/netmaker/tree/master/compose">https://github.com/gravitl/netmaker/tree/master/compose</a></p>
<p>The following is a brief description of each:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/gravitl/netmaker/blob/master/compose/docker-compose.yml">docker-compose.yml</a> -= This maintains the most recommended setup at the moment, using the caddy proxy.</p></li>
<li><p><a class="reference external" href="https://github.com/gravitl/netmaker/blob/master/compose/docker-compose.pro.yml">docker-compose.pro.yml</a> -= This is the compose file needed for Netmaker Professional. You will need a licence and tenant id from <a class="reference external" href="https://account.netmaker.io/">Netmaker’s licence dashboard</a> .</p></li>
</ul>
</section>
</section>
<section id="emqx">
<span id="id2"></span><h2 id="emqx">EMQX<a class="headerlink" href="#emqx" title="Permalink to this headline">¶</a></h2>
<p>Netmaker offers an EMQX option as a broker for your server. The main configuration changes between mosquitto and EMQX is going to take place in the docker-compose.yml, netmaker.env and the Caddyfile.</p>
<p>You can find the EMQX docker-compose file <a class="reference external" href="https://github.com/gravitl/netmaker/blob/master/compose/docker-compose-emqx.yml">in the netmaker repo</a>.</p>
<p>You should not need to make any changes to the docker-compose-emqx.yml file. Just download this file using the command provided below on the same directory as netmaker.env file. It will grab information from the netmaker.env file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">gravitl</span><span class="o">/</span><span class="n">netmaker</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">compose</span><span class="o">/</span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="o">-</span><span class="n">emqx</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p>In your Caddyfile, the only change you need to make is in the mq block.</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="c1"># MQ</span><span class="w"></span>
<span class="na">wss://broker.{$NM_DOMAIN} {</span><span class="w"></span>
<span class="w">    </span><span class="na">reverse_proxy ws://mq:8083</span><span class="w"></span>
<span class="na">}</span><span class="w"></span>
</pre></div>
</div>
<p>basically just replace the port number on line <code class="docutils literal notranslate"><span class="pre">reverse_proxy</span> <span class="pre">ws://mq:8883</span></code> with <code class="docutils literal notranslate"><span class="pre">8083</span></code> emqx websocket port number.</p>
<p>In your netmaker.env file, just replace the line <code class="docutils literal notranslate"><span class="pre">SERVER_BROKER_ENDPOINT="ws://mq:1883"</span></code> with <code class="docutils literal notranslate"><span class="pre">SERVER_BROKER_ENDPOINT=ws://mq:8083/mqtt</span></code>. Basically just change the port to 8083 and add /mqtt after that.</p>
<p>In your docker-compose.yml file, add <code class="docutils literal notranslate"><span class="pre">/mqtt</span></code> at the end of this line <code class="docutils literal notranslate"><span class="pre">BROKER_ENDPOINT=wss://broker.${NM_DOMAIN}</span></code> which results in <code class="docutils literal notranslate"><span class="pre">BROKER_ENDPOINT=wss://broker.${NM_DOMAIN}/mqtt</span></code>.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BROKER_ENDPOINT=wss://broker.${NM_DOMAIN}/mqtt</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BROKER_TYPE=emqx</span><span class="w"></span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">EMQX_REST_ENDPOINT=http://mq:18083</span><span class="w"></span>
</pre></div>
</div>
<p>Then two new lines <code class="docutils literal notranslate"><span class="pre">-</span> <span class="pre">BROKER_TYPE=emqx</span></code> and <code class="docutils literal notranslate"><span class="pre">-</span> <span class="pre">EMQX_REST_ENDPOINT=http://mq:18083</span></code> needs to be added after the line <code class="docutils literal notranslate"><span class="pre">-</span> <span class="pre">BROKER_ENDPOINT=wss://broker.${NM_DOMAIN}/mqtt</span></code> as shown above.</p>
<p>If you are using a professional server, you will need to make changes to your netmaker-exporter section in your docker-compose.override.yml file.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">netmaker-exporter</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netmaker-exporter</span><span class="w"></span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gravitl/netmaker-exporter:latest</span><span class="w"></span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span><span class="w"></span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">netmaker</span><span class="w"></span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">SERVER_BROKER_ENDPOINT</span><span class="p">:</span><span class="w"> </span><span class="s">"ws://mq:8083/mqtt"</span><span class="w"></span>
<span class="w">        </span><span class="nt">BROKER_ENDPOINT</span><span class="p">:</span><span class="w"> </span><span class="s">"wss://broker.nm.${NM_DOMAIN}/mqtt"</span><span class="w"></span>
<span class="w">        </span><span class="nt">PROMETHEUS_HOST</span><span class="p">:</span><span class="w"> </span><span class="s">"https://prometheus.${NM_DOMAIN}"</span><span class="w"></span>
</pre></div>
</div>
<p>At this point you should be able to <code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">down</span> <span class="pre">&amp;&amp;</span> <span class="pre">docker-compose</span> <span class="pre">up</span> <span class="pre">-d</span> <span class="pre">&amp;&amp;</span> <span class="pre">docker-compose</span> <span class="pre">-f</span> <span class="pre">docker-compose-emqx.yml</span> <span class="pre">up</span> <span class="pre">-d</span></code>. Your <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">logs</span> <span class="pre">mq</span></code> should look something like this.</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="na">Listener ssl:default on 0.0.0.0:8883 started.</span><span class="w"></span>
<span class="na">Listener tcp:default on 0.0.0.0:1883 started.</span><span class="w"></span>
<span class="na">Listener ws:default on 0.0.0.0:8083 started.</span><span class="w"></span>
<span class="na">Listener wss:default on 0.0.0.0:8084 started.</span><span class="w"></span>
<span class="na">Listener http:dashboard on :18083 started.</span><span class="w"></span>
<span class="na">EMQX 5.0.9 is running now!</span><span class="w"></span>
</pre></div>
</div>
<p>Your server is now running on an EMQX broker. you can view your EMQX dashboard with <code class="docutils literal notranslate"><span class="pre">http://&lt;serverip&gt;:18083/</span></code>. The signin credentials are the EMQX_DASHBOARD__DEFAULT_USERNAME and EMQX_DASHBOARD__DEFAULT_PASSWORD located in your netmaker.env file. This dashboard will give you all the information about your mq activity going on in your netmaker server.</p>
</section>
<section id="linux-install-without-docker">
<span id="nodocker"></span><h2 id="linux-install-without-docker">Linux Install without Docker<a class="headerlink" href="#linux-install-without-docker" title="Permalink to this headline">¶</a></h2>
<p>Most systems support Docker, but some do not. In such environments, there are many options for installing Netmaker. Netmaker is available as a binary file, and there is a zip file of the Netmaker UI static HTML on GitHub. Beyond the UI and Server, you may want to optionally install a database (SQLite is embedded, rqlite or postgres are supported) and CoreDNS (also optional).</p>
<p>Once this is enabled and configured for a domain, you can continue with the below. The recommended server runs Ubuntu 20.04.</p>
<section id="database-setup-optional">
<h3 id="database-setup-optional">Database Setup (optional)<a class="headerlink" href="#database-setup-optional" title="Permalink to this headline">¶</a></h3>
<p>You can run the netmaker binary standalone and it will run an embedded SQLite server. Data goes in the data/ directory. Optionally, you can run PostgreSQL or rqlite. Instructions for rqlite are below.</p>
<ol class="arabic simple">
<li><p>Install rqlite on your server: <a class="reference external" href="https://github.com/rqlite/rqlite">https://github.com/rqlite/rqlite</a></p></li>
<li><p>Run rqlite: rqlited -node-id 1 ~/node.1</p></li>
</ol>
<p>If using rqlite or postgres, you must change the DATABASE environment/config variable and enter connection details.</p>
</section>
<section id="server-setup-using-sqlite">
<h3 id="server-setup-using-sqlite">Server Setup (using sqlite)<a class="headerlink" href="#server-setup-using-sqlite" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Get the binary. <code class="docutils literal notranslate"><span class="pre">wget</span> <span class="pre">-O</span> <span class="pre">/etc/netmaker/netmaker</span> <span class="pre">https://github.com/gravitl/netmaker/releases/download/$VERSION/netmaker</span></code></p></li>
<li><p>Move the binary to /usr/sbin and make it executable.</p></li>
<li><p>create a config file. /etc/netmaker/netmaker.yml</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">server</span><span class="p">:</span><span class="w"></span>
<span class="w">  </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="s">"&lt;YOUR_BASE_DOMAIN&gt;"</span><span class="w"></span>
<span class="w">  </span><span class="nt">broker</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wss://broker.&lt;YOUR_BASE_DOMAIN&gt;</span><span class="w"></span>
<span class="w">  </span><span class="nt">apiport</span><span class="p">:</span><span class="w"> </span><span class="s">"8081"</span><span class="w"></span>
<span class="w">  </span><span class="nt">apiconn</span><span class="p">:</span><span class="w"> </span><span class="s">"api.&lt;YOUR_BASE_DOMAIN&gt;:443"</span><span class="w"></span>
<span class="w">  </span><span class="nt">masterkey</span><span class="p">:</span><span class="w"> </span><span class="s">"&lt;SECRET_KEY&gt;"</span><span class="w"></span>
<span class="w">  </span><span class="nt">mqpassword</span><span class="p">:</span><span class="w"> </span><span class="s">"&lt;YOUR_PASSWORD&gt;"</span><span class="w"></span>
<span class="w">  </span><span class="nt">mqusername</span><span class="p">:</span><span class="w"> </span><span class="s">"&lt;YOUR_USERNAME&gt;"</span><span class="w"></span>
<span class="w">  </span><span class="nt">serverbrokerendpoint</span><span class="p">:</span><span class="w"> </span><span class="s">"ws://mq:1883"</span><span class="w"></span>
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>Update YOUR_BASE_DOMAIN and SECRET_KEY as well as username and passwords for mq.</p></li>
<li><p>create your netmaker.service file /etc/systemd/system/netmaker.service</p></li>
</ol>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="k">[Unit]</span><span class="w"></span>
<span class="na">Description</span><span class="o">=</span><span class="s">Netmaker Server</span><span class="w"></span>
<span class="na">After</span><span class="o">=</span><span class="s">network.target</span><span class="w"></span>

<span class="k">[Service]</span><span class="w"></span>
<span class="na">Type</span><span class="o">=</span><span class="s">simple</span><span class="w"></span>
<span class="na">Restart</span><span class="o">=</span><span class="s">on-failure</span><span class="w"></span>

<span class="na">ExecStart</span><span class="o">=</span><span class="s">/usr/sbin/netmaker -c /etc/netmaker/netmaker.yml</span><span class="w"></span>

<span class="k">[Install]</span><span class="w"></span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span><span class="w"></span>
</pre></div>
</div>
<ol class="arabic simple" start="6">
<li><p><code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">daemon-reload</span></code></p></li>
<li><p>Check status:  <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">journalctl</span> <span class="pre">-u</span> <span class="pre">netmaker</span></code></p></li>
<li><p>If any settings are incorrect such as host or sql credentials, change them under /etc/netmaker/netmaker.yml and then run <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">restart</span> <span class="pre">netmaker</span></code></p></li>
</ol>
</section>
<section id="ui-setup">
<h3 id="ui-setup">UI Setup<a class="headerlink" href="#ui-setup" title="Permalink to this headline">¶</a></h3>
<p>The following uses Caddy as a file server/proxy.</p>
<ol class="arabic simple">
<li><dl class="simple">
<dt>Download and Unzip UI asset files from <a class="reference external" href="https://github.com/gravitl/netmaker-ui/releases">https://github.com/gravitl/netmaker-ui/releases</a> and put them in /var/www/netmaker</dt><dd><p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">wget</span> <span class="pre">-O</span> <span class="pre">/tmp/netmaker-ui.zip</span> <span class="pre">https://github.com/gravitl/netmaker-ui/releases/download/latest/netmaker-ui.zip</span></code>
<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">unzip</span> <span class="pre">/tmp/netmaker-ui.zip</span> <span class="pre">-d</span> <span class="pre">/var/www/netmaker</span></code></p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Create config.js in /var/www/netmaker</dt><dd><p><code class="docutils literal notranslate"><span class="pre">window.REACT_APP_BACKEND='https://api.&lt;YOUR_BASE_DOMAIN&gt;'</span></code></p>
</dd>
</dl>
</li>
</ol>
</section>
<section id="proxy-http-server">
<h3 id="proxy-http-server">Proxy / Http server<a class="headerlink" href="#proxy-http-server" title="Permalink to this headline">¶</a></h3>
</section>
<section id="caddy">
<h3 id="caddy">Caddy<a class="headerlink" href="#caddy" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Install Caddy</p></li>
<li><p>You should have a Caddy file from installing caddy. Replace the contents of that file with this configuration.</p></li>
</ol>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="na">{</span><span class="w"></span>
<span class="w">    </span><span class="c1"># ZeroSSL account</span><span class="w"></span>
<span class="w">    </span><span class="na">acme_ca https://acme.zerossl.com/v2/DV90</span><span class="w"></span>
<span class="w">    </span><span class="na">email &lt;YOUR_EMAIL&gt;</span><span class="w"></span>
<span class="na">}</span><span class="w"></span>

<span class="c1"># Dashboard</span><span class="w"></span>
<span class="na">https://dashboard.&lt;YOUR_BASE_DOMAIN&gt; {</span><span class="w"></span>
<span class="w">    </span><span class="na">header {</span><span class="w"></span>
<span class="w">        </span><span class="na">Access-Control-Allow-Origin *.&lt;YOUR_BASE_DOMAIN&gt;</span><span class="w"></span>
<span class="w">        </span><span class="na">Strict-Transport-Security "max-age</span><span class="o">=</span><span class="s">31536000;"</span><span class="w"></span>
<span class="w">        </span><span class="na">X-XSS-Protection "1; mode</span><span class="o">=</span><span class="s">block"</span><span class="w"></span>
<span class="w">        </span><span class="na">X-Frame-Options "SAMEORIGIN"</span><span class="w"></span>
<span class="w">        </span><span class="na">X-Robots-Tag "none"</span><span class="w"></span>
<span class="w">        </span><span class="na">-Server</span><span class="w"></span>
<span class="w">    </span><span class="na">}</span><span class="w"></span>
<span class="w">    </span><span class="na">root * /var/www/netmaker</span><span class="w"></span>
<span class="w">    </span><span class="na">file_server</span><span class="w"></span>
<span class="na">}</span><span class="w"></span>

<span class="c1"># API</span><span class="w"></span>
<span class="na">https://api.&lt;YOUR_BASE_DOMAIN&gt; {</span><span class="w"></span>
<span class="w">    </span><span class="na">reverse_proxy http://127.0.0.1:8081</span><span class="w"></span>
<span class="na">}</span><span class="w"></span>
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>start Caddy</p></li>
</ol>
</section>
<section id="mq">
<h3 id="mq">MQ<a class="headerlink" href="#mq" title="Permalink to this headline">¶</a></h3>
<p>You will need an MQTT broker on the host. We recommend Mosquitto. In addition, it must use the mosquitto.conf file. Depending on The version, you will use one of the two files.</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="c1"># use this config for versions earlier than v0.16.1</span><span class="w"></span>

<span class="na">per_listener_settings true</span><span class="w"></span>

<span class="na">listener 8883</span><span class="w"></span>
<span class="na">allow_anonymous false</span><span class="w"></span>
<span class="na">require_certificate true</span><span class="w"></span>
<span class="na">use_identity_as_username false</span><span class="w"></span>
<span class="na">cafile /etc/mosquitto/certs/root.pem</span><span class="w"></span>
<span class="na">certfile /etc/mosquitto/certs/server.pem</span><span class="w"></span>
<span class="na">keyfile /etc/mosquitto/certs/server.key</span><span class="w"></span>

<span class="na">listener 1883</span><span class="w"></span>
<span class="na">allow_anonymous true</span><span class="w"></span>
</pre></div>
</div>
<p>Start netmaker
Copy root.pem, server.pem, and server.key from /etc/netmaker to /etc/mosquitto/certs/</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#use this config file for v0.16.1 and later.</span>
<span class="n">per_listener_settings</span> <span class="n">false</span>
<span class="n">listener</span> <span class="mi">8883</span>
<span class="n">allow_anonymous</span> <span class="n">false</span>

<span class="n">listener</span> <span class="mi">1883</span>
<span class="n">allow_anonymous</span> <span class="n">false</span>

<span class="n">plugin</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">mosquitto_dynamic_security</span><span class="o">.</span><span class="n">so</span>
<span class="n">plugin_opt_config_file</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mosquitto</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">dynamic</span><span class="o">-</span><span class="n">security</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>Copy dynamic-security.json from etc/netmaker to /etc/mosquitto/data.
Restart netmaker.
Restart mosquitto.
You can check the status of caddy, mosquitto, and netmaker with <code class="docutils literal notranslate"><span class="pre">journalctl</span> <span class="pre">-fu</span> <span class="pre">&lt;ONE_OF_THOSE_THREE&gt;</span></code> to make sure everything is working.</p>
</section>
</section>
<section id="kubernetes-install">
<span id="kubeinstall"></span><h2 id="kubernetes-install">Kubernetes Install<a class="headerlink" href="#kubernetes-install" title="Permalink to this headline">¶</a></h2>
<section id="server-install">
<h3 id="server-install">Server Install<a class="headerlink" href="#server-install" title="Permalink to this headline">¶</a></h3>
<p>This template assumes your cluster uses Nginx for ingress with valid wildcard certificates. If using an ingress controller other than Nginx (ex: Traefik), you will need to manually modify the Ingress entries in this template to match your environment.</p>
<p>This template also requires RWX storage. Please change references to storageClassName in this template to your cluster’s Storage Class.</p>
<p><code class="docutils literal notranslate"><span class="pre">wget</span> <span class="pre">https://raw.githubusercontent.com/gravitl/netmaker/master/kube/netmaker-template.yaml</span></code></p>
<p>Replace the NETMAKER_BASE_DOMAIN references to the base domain you would like for your Netmaker services (ui,api,grpc). Typically this will be something like <strong>netmaker.yourwildcard.com</strong>.</p>
<p><code class="docutils literal notranslate"><span class="pre">sed</span> <span class="pre">-i</span> <span class="pre">‘s/NETMAKER_BASE_DOMAIN/&lt;your</span> <span class="pre">base</span> <span class="pre">domain&gt;/g’</span> <span class="pre">netmaker-template.yaml</span></code></p>
<p>Now, assuming Ingress and Storage match correctly with your cluster configuration, you can install Netmaker.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">create</span> <span class="n">ns</span> <span class="n">nm</span>
<span class="n">kubectl</span> <span class="n">config</span> <span class="nb">set</span><span class="o">-</span><span class="n">context</span> <span class="o">--</span><span class="n">current</span> <span class="o">--</span><span class="n">namespace</span><span class="o">=</span><span class="n">nm</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="n">netmaker</span><span class="o">-</span><span class="n">template</span><span class="o">.</span><span class="n">yaml</span> <span class="o">-</span><span class="n">n</span> <span class="n">nm</span>
</pre></div>
</div>
<p>In about 3 minutes, everything should be up and running:</p>
<p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">ingress</span> <span class="pre">nm-ui-ingress-nginx</span></code></p>
</section>
<section id="netclient-daemonset">
<h3 id="netclient-daemonset">Netclient Daemonset<a class="headerlink" href="#netclient-daemonset" title="Permalink to this headline">¶</a></h3>
<p>The following instructions assume you have Netmaker running and a network you would like to add your cluster into. The Netmaker server does not need to be running inside of a cluster for this.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>wget https://raw.githubusercontent.com/gravitl/netmaker/master/kube/netclient-template.yaml
sed -i ‘s/ACCESS_TOKEN_VALUE/&lt; your access token value&gt;/g’ netclient-template.yaml
kubectl apply -f netclient-template.yaml
</pre></div>
</div>
<p>For a more detailed guide on integrating Netmaker with MicroK8s, <a class="reference external" href="https://itnext.io/how-to-deploy-a-cross-cloud-kubernetes-cluster-with-built-in-disaster-recovery-bbce27fcc9d7">check out this guide</a>.</p>
</section>
</section>
<section id="nginx-reverse-proxy-setup-with-https">
<h2 id="nginx-reverse-proxy-setup-with-https">Nginx Reverse Proxy Setup with https<a class="headerlink" href="#nginx-reverse-proxy-setup-with-https" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="https://github.com/linuxserver/docker-swag">Swag Proxy</a> makes it easy to generate a valid SSL certificate for the config below. Here is the <a class="reference external" href="https://docs.linuxserver.io/general/swag">documentation</a> for the installation.</p>
<p>The following file configures Netmaker as a subdomain. This config is an adaption from the swag proxy project.</p>
<p>./netmaker.subdomain.conf:</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">server</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1"># Redirect HTTP to HTTPS.</span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">*.netmaker.example.org</span><span class="p">;</span><span class="w"> </span><span class="c1"># Please change to your domain</span>
<span class="w">    </span><span class="kn">return</span><span class="w"> </span><span class="mi">301</span><span class="w"> </span><span class="s">https://</span><span class="nv">$host$request_uri</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="k">server</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="s">ssl</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="s">[::]:443</span><span class="w"> </span><span class="s">ssl</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">dashboard.netmaker.example.org</span><span class="p">;</span><span class="w"> </span><span class="c1"># Please change to your domain</span>
<span class="w">    </span><span class="kn">include</span><span class="w"> </span><span class="s">/config/nginx/ssl.conf</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://&lt;NETMAKER_IP&gt;:8082</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="k">server</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="s">ssl</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">listen</span><span class="w"> </span><span class="s">[::]:443</span><span class="w"> </span><span class="s">ssl</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">server_name</span><span class="w"> </span><span class="s">api.netmaker.example.org</span><span class="p">;</span><span class="w"> </span><span class="c1"># Please change to your domain</span>
<span class="w">    </span><span class="kn">include</span><span class="w"> </span><span class="s">/config/nginx/ssl.conf</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="kn">proxy_pass</span><span class="w"> </span><span class="s">http://&lt;NETMAKER_IP&gt;:8081</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="kn">proxy_set_header</span><span class="w">            </span><span class="s">Host</span><span class="w"> </span><span class="s">api.netmaker.example.org</span><span class="p">;</span><span class="w"> </span><span class="c1"># Please change to your domain</span>
<span class="w">        </span><span class="kn">proxy_pass_request_headers</span><span class="w">  </span><span class="no">on</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="nginx-proxy-manager-setup">
<h2 id="nginx-proxy-manager-setup">Nginx Proxy Manager Setup<a class="headerlink" href="#nginx-proxy-manager-setup" title="Permalink to this headline">¶</a></h2>
<p>To use Netmaker with Nginx Proxy Manager, three proxy hosts should be added, one for each subdomain used by netmaker. Each subdomain should have SSL enable and be configured as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">api</span><span class="o">.</span><span class="n">netmaker</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span>
<span class="n">Forward</span> <span class="n">Hostname</span><span class="o">/</span><span class="n">IP</span><span class="p">:</span> <span class="n">netmaker</span>
<span class="n">Forward</span> <span class="n">Port</span><span class="p">:</span> <span class="mi">8081</span>
<span class="n">dashboard</span><span class="o">.</span><span class="n">netmaker</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span>
<span class="n">Forward</span> <span class="n">Hostname</span><span class="o">/</span><span class="n">IP</span><span class="p">:</span> <span class="n">netmaker</span><span class="o">-</span><span class="n">ui</span>
<span class="n">Forward</span> <span class="n">Port</span><span class="p">:</span> <span class="mi">80</span>
<span class="n">grpc</span><span class="o">.</span><span class="n">netmaker</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span><span class="p">:</span>
<span class="n">Forward</span> <span class="n">Hostname</span><span class="o">/</span><span class="n">IP</span><span class="p">:</span> <span class="n">netmaker</span>
<span class="n">Forward</span> <span class="n">Port</span><span class="p">:</span> <span class="mi">50051</span>
<span class="n">Custom</span> <span class="n">Locations</span><span class="p">:</span>
<span class="n">Add</span> <span class="n">location</span> <span class="o">/</span>
<span class="n">Forward</span> <span class="n">Hostname</span><span class="o">/</span><span class="n">IP</span><span class="p">:</span> <span class="n">netmaker</span>
<span class="n">Forward</span> <span class="n">Port</span><span class="p">:</span> <span class="mi">50051</span>
<span class="n">Custom</span> <span class="n">config</span> <span class="p">(</span><span class="n">gear</span> <span class="n">button</span><span class="p">):</span> <span class="n">grpc_pass</span> <span class="n">netmaker</span><span class="p">:</span><span class="mi">50051</span><span class="p">;</span>
</pre></div>
</div>
<p>The following is a cleaned up config generated by Nginx Proxy Manager to show how nginx can be configured to support Netmaker. This does not include the neccessary SSL configuration.</p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># dashboard.netmaker.example.com</span>
<span class="c1"># ------------------------------------------------------------</span>
<span class="k">server</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kn">set</span><span class="w"> </span><span class="nv">$forward_scheme</span><span class="w"> </span><span class="s">http</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">set</span><span class="w"> </span><span class="nv">$server</span><span class="w">         </span><span class="s">"netmaker-ui"</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">set</span><span class="w"> </span><span class="nv">$port</span><span class="w">           </span><span class="mi">80</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="s">[::]:80</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="s">ssl</span><span class="w"> </span><span class="s">http2</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="s">[::]:443</span><span class="w"> </span><span class="s">ssl</span><span class="w"> </span><span class="s">http2</span><span class="p">;</span><span class="w"></span>
<span class="kn">server_name</span><span class="w"> </span><span class="s">dashboard.netmaker.example.com</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1"># Proxy!</span>
<span class="w">    </span><span class="kn">include</span><span class="w"> </span><span class="s">conf.d/include/proxy.conf</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="c1">#above file includes:</span>
<span class="w">        </span><span class="c1">#add_header       X-Served-By $host;</span>
<span class="w">        </span><span class="c1">#proxy_set_header Host $host;</span>
<span class="w">        </span><span class="c1">#proxy_set_header X-Forwarded-Scheme $scheme;</span>
<span class="w">        </span><span class="c1">#proxy_set_header X-Forwarded-Proto  $scheme;</span>
<span class="w">        </span><span class="c1">#proxy_set_header X-Forwarded-For    $remote_addr;</span>
<span class="w">        </span><span class="c1">#proxy_set_header X-Real-IP          $remote_addr;</span>
<span class="w">        </span><span class="c1">#proxy_pass       $forward_scheme://$server:$port$request_uri;</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># api.netmaker.example.com</span>
<span class="c1"># ------------------------------------------------------------</span>
<span class="k">server</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kn">set</span><span class="w"> </span><span class="nv">$forward_scheme</span><span class="w"> </span><span class="s">http</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">set</span><span class="w"> </span><span class="nv">$server</span><span class="w">         </span><span class="s">"netmaker"</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">set</span><span class="w"> </span><span class="nv">$port</span><span class="w">           </span><span class="mi">8081</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="s">[::]:80</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="s">ssl</span><span class="w"> </span><span class="s">http2</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="s">[::]:443</span><span class="w"> </span><span class="s">ssl</span><span class="w"> </span><span class="s">http2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">server_name</span><span class="w"> </span><span class="s">api.netmaker.example.com</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1"># Proxy!</span>
<span class="w">    </span><span class="kn">include</span><span class="w"> </span><span class="s">conf.d/include/proxy.conf</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="c1">#above file includes:</span>
<span class="w">        </span><span class="c1">#add_header       X-Served-By $host;</span>
<span class="w">        </span><span class="c1">#proxy_set_header Host $host;</span>
<span class="w">        </span><span class="c1">#proxy_set_header X-Forwarded-Scheme $scheme;</span>
<span class="w">        </span><span class="c1">#proxy_set_header X-Forwarded-Proto  $scheme;</span>
<span class="w">        </span><span class="c1">#proxy_set_header X-Forwarded-For    $remote_addr;</span>
<span class="w">        </span><span class="c1">#proxy_set_header X-Real-IP          $remote_addr;</span>
<span class="w">        </span><span class="c1">#proxy_pass       $forward_scheme://$server:$port$request_uri;</span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1"># ------------------------------------------------------------</span>
<span class="c1"># grpc.netmaker.example.com</span>
<span class="c1"># ------------------------------------------------------------</span>
<span class="k">server</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">  </span><span class="kn">set</span><span class="w"> </span><span class="nv">$forward_scheme</span><span class="w"> </span><span class="s">http</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">set</span><span class="w"> </span><span class="nv">$server</span><span class="w">         </span><span class="s">"netmaker"</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">set</span><span class="w"> </span><span class="nv">$port</span><span class="w">           </span><span class="mi">50051</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="s">[::]:80</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="mi">443</span><span class="w"> </span><span class="s">ssl</span><span class="w"> </span><span class="s">http2</span><span class="p">;</span><span class="w"></span>
<span class="kn">listen</span><span class="w"> </span><span class="s">[::]:443</span><span class="w"> </span><span class="s">ssl</span><span class="w"> </span><span class="s">http2</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">server_name</span><span class="w"> </span><span class="s">grpc.netmaker.example.com</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="kn">location</span><span class="w"> </span><span class="s">/</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">Host</span><span class="w"> </span><span class="nv">$host</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-Scheme</span><span class="w"> </span><span class="nv">$scheme</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-Proto</span><span class="w">  </span><span class="nv">$scheme</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Forwarded-For</span><span class="w">    </span><span class="nv">$remote_addr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_set_header</span><span class="w"> </span><span class="s">X-Real-IP</span><span class="w">          </span><span class="nv">$remote_addr</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">proxy_pass</span><span class="w">       </span><span class="s">http://netmaker:50051</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kn">grpc_pass</span><span class="w"> </span><span class="n">netmaker</span><span class="p">:</span><span class="mi">50051</span><span class="p">;</span><span class="w"></span>
<span class="w">  </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="highly-available-installation-kubernetes">
<span id="hainstall"></span><h2 id="highly-available-installation-kubernetes">Highly Available Installation (Kubernetes)<a class="headerlink" href="#highly-available-installation-kubernetes" title="Permalink to this headline">¶</a></h2>
<p>Netmaker comes with a Helm chart to deploy with High Availability on Kubernetes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">repo</span> <span class="n">add</span> <span class="n">netmaker</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">gravitl</span><span class="o">.</span><span class="n">github</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">netmaker</span><span class="o">-</span><span class="n">helm</span><span class="o">/</span>
<span class="n">helm</span> <span class="n">repo</span> <span class="n">update</span>
</pre></div>
</div>
<section id="requirements">
<h3 id="requirements">Requirements<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h3>
<p>To run HA Netmaker on Kubernetes, your cluster must have the following:
- RWO and RWX Storage Classes (RWX is only required if running Netmaker with DNS Management enabled).
- An Ingress Controller and valid TLS certificates
- This chart can currently generate ingress for Nginx or Traefik Ingress with LetsEncrypt + Cert Manager
- If LetsEncrypt and CertManager are not deployed, you must manually configure certificates for your ingress</p>
<p>Furthermore, the chart will by default install and use a postgresql cluster as its datastore.</p>
</section>
<section id="recommended-settings">
<h3 id="recommended-settings">Recommended Settings:<a class="headerlink" href="#recommended-settings" title="Permalink to this headline">¶</a></h3>
<p>A minimal HA install of Netmaker can be run with the following command:
<cite>helm install netmaker –generate-name –set baseDomain=nm.example.com</cite>
This install has some notable exceptions:
- Ingress <strong>must</strong> be manually configured post-install (need to create valid Ingress with TLS)
- Server will use “userspace” WireGuard, which is slower than kernel WG
- DNS will be disabled</p>
</section>
<section id="example-installations">
<h3 id="example-installations">Example Installations:<a class="headerlink" href="#example-installations" title="Permalink to this headline">¶</a></h3>
<p>An annotated install command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">install</span> <span class="n">netmaker</span><span class="o">/</span><span class="n">netmaker</span> <span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">name</span> \ <span class="c1"># generate a random id for the deploy</span>
<span class="o">--</span><span class="nb">set</span> <span class="n">baseDomain</span><span class="o">=</span><span class="n">nm</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> \ <span class="c1"># the base wildcard domain to use for the netmaker api/dashboard/grpc ingress</span>
<span class="o">--</span><span class="nb">set</span> <span class="n">replicas</span><span class="o">=</span><span class="mi">3</span> \ <span class="c1"># number of server replicas to deploy (3 by default)</span>
<span class="o">--</span><span class="nb">set</span> <span class="n">ingress</span><span class="o">.</span><span class="n">enabled</span><span class="o">=</span><span class="n">true</span> \ <span class="c1"># deploy ingress automatically (requires nginx or traefik and cert-manager + letsencrypt)</span>
<span class="o">--</span><span class="nb">set</span> <span class="n">ingress</span><span class="o">.</span><span class="n">className</span><span class="o">=</span><span class="n">nginx</span> \ <span class="c1"># ingress class to use</span>
<span class="o">--</span><span class="nb">set</span> <span class="n">ingress</span><span class="o">.</span><span class="n">tls</span><span class="o">.</span><span class="n">issuerName</span><span class="o">=</span><span class="n">letsencrypt</span><span class="o">-</span><span class="n">prod</span> \ <span class="c1"># LetsEncrypt certificate issuer to use</span>
<span class="o">--</span><span class="nb">set</span> <span class="n">dns</span><span class="o">.</span><span class="n">enabled</span><span class="o">=</span><span class="n">true</span> \ <span class="c1"># deploy and enable private DNS management with CoreDNS</span>
<span class="o">--</span><span class="nb">set</span> <span class="n">dns</span><span class="o">.</span><span class="n">clusterIP</span><span class="o">=</span><span class="mf">10.245.75.75</span> <span class="o">--</span><span class="nb">set</span> <span class="n">dns</span><span class="o">.</span><span class="n">RWX</span><span class="o">.</span><span class="n">storageClassName</span><span class="o">=</span><span class="n">nfs</span> \ <span class="c1"># required fields for DNS</span>
<span class="o">--</span><span class="nb">set</span> <span class="n">postgresql</span><span class="o">-</span><span class="n">ha</span><span class="o">.</span><span class="n">postgresql</span><span class="o">.</span><span class="n">replicaCount</span><span class="o">=</span><span class="mi">2</span> \ <span class="c1"># number of DB replicas to deploy (default 2)</span>
</pre></div>
</div>
<p>The below command will install netmaker with two server replicas, a coredns server, and ingress with routes of api.nm.example.com, grpc.nm.example.com, and dashboard.nm.example.com. CoreDNS will be reachable at 10.245.75.75, and will use NFS to share a volume with Netmaker (to configure dns entries).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm</span> <span class="n">install</span> <span class="n">netmaker</span><span class="o">/</span><span class="n">netmaker</span> <span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">name</span> <span class="o">--</span><span class="nb">set</span> <span class="n">baseDomain</span><span class="o">=</span><span class="n">nm</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> \
<span class="o">--</span><span class="nb">set</span> <span class="n">replicas</span><span class="o">=</span><span class="mi">2</span> <span class="o">--</span><span class="nb">set</span> <span class="n">ingress</span><span class="o">.</span><span class="n">enabled</span><span class="o">=</span><span class="n">true</span> <span class="o">--</span><span class="nb">set</span> <span class="n">dns</span><span class="o">.</span><span class="n">enabled</span><span class="o">=</span><span class="n">true</span> \
<span class="o">--</span><span class="nb">set</span> <span class="n">dns</span><span class="o">.</span><span class="n">clusterIP</span><span class="o">=</span><span class="mf">10.245.75.75</span> <span class="o">--</span><span class="nb">set</span> <span class="n">dns</span><span class="o">.</span><span class="n">RWX</span><span class="o">.</span><span class="n">storageClassName</span><span class="o">=</span><span class="n">nfs</span> \
<span class="o">--</span><span class="nb">set</span> <span class="n">ingress</span><span class="o">.</span><span class="n">className</span><span class="o">=</span><span class="n">nginx</span>
</pre></div>
</div>
<p>The below command will install netmaker with three server replicas (the default), <strong>no coredns</strong>, and ingress with routes of api.netmaker.example.com, grpc.netmaker.example.com, and dashboard.netmaker.example.com. There will be one UI replica instead of two and one database instance instead of two. Traefik will look for a ClusterIssuer named “le-prod-2” to get valid certificates for the ingress.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">helm3</span> <span class="n">install</span> <span class="n">netmaker</span><span class="o">/</span><span class="n">netmaker</span> <span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">name</span> \
<span class="o">--</span><span class="nb">set</span> <span class="n">baseDomain</span><span class="o">=</span><span class="n">netmaker</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span> <span class="o">--</span><span class="nb">set</span> <span class="n">postgresql</span><span class="o">-</span><span class="n">ha</span><span class="o">.</span><span class="n">postgresql</span><span class="o">.</span><span class="n">replicaCount</span><span class="o">=</span><span class="mi">1</span> \
<span class="o">--</span><span class="nb">set</span> <span class="n">ui</span><span class="o">.</span><span class="n">replicas</span><span class="o">=</span><span class="mi">1</span> <span class="o">--</span><span class="nb">set</span> <span class="n">ingress</span><span class="o">.</span><span class="n">enabled</span><span class="o">=</span><span class="n">true</span> \
<span class="o">--</span><span class="nb">set</span> <span class="n">ingress</span><span class="o">.</span><span class="n">tls</span><span class="o">.</span><span class="n">issuerName</span><span class="o">=</span><span class="n">le</span><span class="o">-</span><span class="n">prod</span><span class="o">-</span><span class="mi">2</span> <span class="o">--</span><span class="nb">set</span> <span class="n">ingress</span><span class="o">.</span><span class="n">className</span><span class="o">=</span><span class="n">traefik</span>
</pre></div>
</div>
<p>Below, we discuss the considerations for Ingress, Kernel WireGuard, and DNS.</p>
</section>
<section id="ingress">
<h3 id="ingress">Ingress<a class="headerlink" href="#ingress" title="Permalink to this headline">¶</a></h3>
<p>To run HA Netmaker, you must have ingress installed and enabled on your cluster with valid TLS certificates (not self-signed). If you are running Nginx as your Ingress Controller and LetsEncrypt for TLS certificate management, you can run the helm install with the following settings:</p>
<ul class="simple">
<li><p><cite>–set ingress.enabled=true</cite></p></li>
<li><p><cite>–set ingress.annotations.cert-manager.io/cluster-issuer=&lt;your LE issuer name&gt;</cite></p></li>
</ul>
<p>If you are not using Nginx or Traefik and LetsEncrypt, we recommend leaving ingress.enabled=false (default), and then manually creating the ingress objects post-install. You will need three ingress objects with TLS:</p>
<ul class="simple">
<li><p><cite>dashboard.&lt;baseDomain&gt;</cite></p></li>
<li><p><cite>api.&lt;baseDomain&gt;</cite></p></li>
<li><p><cite>grpc.&lt;baseDomain&gt;</cite></p></li>
</ul>
<p>If deploying manually, the gRPC ingress object requires special considerations. Look up the proper way to route grpc with your ingress controller. For instance, on Traefik, an IngressRouteTCP object is required.</p>
<p>There are some example ingress objects in the kube/example folder.</p>
</section>
<section id="kernel-wireguard">
<h3 id="kernel-wireguard">Kernel WireGuard<a class="headerlink" href="#kernel-wireguard" title="Permalink to this headline">¶</a></h3>
<p>If you have control of the Kubernetes worker node servers, we recommend <strong>first</strong> installing WireGuard on the hosts, and then installing HA Netmaker in Kernel mode. By default, Netmaker will install with userspace WireGuard (wireguard-go) for maximum compatibility and to avoid needing permissions at the host level. If you have installed WireGuard on your hosts, you should install Netmaker’s helm chart with the following option:</p>
<ul class="simple">
<li><p><cite>–set wireguard.kernel=true</cite></p></li>
</ul>
</section>
<section id="dns">
<h3 id="dns">DNS<a class="headerlink" href="#dns" title="Permalink to this headline">¶</a></h3>
<p>By Default, the helm chart will deploy without DNS enabled. To enable DNS, specify with:</p>
<ul class="simple">
<li><p><cite>–set dns.enabled=true</cite></p></li>
</ul>
<p>This will require specifying a RWX storage class, e.g.:</p>
<ul class="simple">
<li><p><cite>–set dns.RWX.storageClassName=nfs</cite></p></li>
</ul>
<p>This will also require specifying a service address for DNS. Choose a valid ipv4 address from the service IP CIDR for your cluster, e.g.:</p>
<ul class="simple">
<li><p><cite>–set dns.clusterIP=10.245.69.69</cite></p></li>
</ul>
<p><strong>This address will only be reachable from hosts that have access to the cluster service CIDR.</strong> It is only designed for use cases related to k8s. If you want a more general-use Netmaker server on Kubernetes for use cases outside of k8s, you will need to do one of the following:
- bind the CoreDNS service to port 53 on one of your worker nodes and set the COREDNS_ADDRESS equal to the public IP of the worker node
- Create a private Network with Netmaker and set the COREDNS_ADDRESS equal to the private address of the host running CoreDNS. For this, CoreDNS will need a node selector and will ideally run on the same host as one of the Netmaker server instances.</p>
</section>
<section id="values">
<h3 id="values">Values<a class="headerlink" href="#values" title="Permalink to this headline">¶</a></h3>
<p>To view all options for the chart, please visit the README in the code repo <a class="reference external" href="https://github.com/gravitl/netmaker/tree/master/kube/helm#values">here</a> .</p>
</section>
</section>
<section id="highly-available-installation-vms-bare-metal">
<h2 id="highly-available-installation-vms-bare-metal">Highly Available Installation (VMs/Bare Metal)<a class="headerlink" href="#highly-available-installation-vms-bare-metal" title="Permalink to this headline">¶</a></h2>
<p>For a professional Netmaker installation, you will need a server that is highly available, to ensure redundant WireGuard routing when any server goes down. To do this, you will need:</p>
<ol class="arabic simple">
<li><p>A load balancer</p></li>
<li><p>3+ Netmaker server instances</p></li>
<li><p>rqlite or PostgreSQL as the backing database</p></li>
</ol>
<p>These documents outline general HA installation guidelines. Netmaker is highly customizable to meet a wide range of professional environments. If you would like support with a professional-grade Netmaker installation, you can <a class="reference external" href="https://gravitl.com/book">schedule a consultation here</a> .</p>
<p>The main consideration for this document is how to configure rqlite. Most other settings and procedures match the standardized way of making applications HA: Load balancing to multiple instances, and sharing a DB. In our case, the DB (rqlite) is distributed, making HA data more easily achievable.</p>
<p>If using PostgreSQL, follow their documentation for <a class="reference external" href="https://www.postgresql.org/docs/14/high-availability.html">installing in HA mode</a> and skip step #2.</p>
<section id="load-balancer-setup">
<h3 id="load-balancer-setup">1. Load Balancer Setup<a class="headerlink" href="#load-balancer-setup" title="Permalink to this headline">¶</a></h3>
<p>Your load balancer of choice will send requests to the Netmaker servers. Setup is similar to the various guides we have created for Nginx, Caddy, and Traefik. SSL certificates must also be configured and handled by the LB.</p>
</section>
<section id="rqlite-setup">
<h3 id="rqlite-setup">2. rqlite Setup<a class="headerlink" href="#rqlite-setup" title="Permalink to this headline">¶</a></h3>
<p>rqlite is the included distributed datastore for an HA Netmaker installation. If you have a different corporate database you wish to integrate, Netmaker is easily extended to other DB’s. If this is a requirement, please contact us.</p>
<p>Assuming you use rqlite, you must run it on each Netmaker server VM, or alongside that VM as a container. Setup a config.json for database credentials (password supports BCRYPT HASHING) and mount in working directory of rqlite and specify with <cite>-auth config.json</cite> :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[{</span>
    <span class="s2">"username"</span><span class="p">:</span> <span class="s2">"netmaker"</span><span class="p">,</span>
    <span class="s2">"password"</span><span class="p">:</span> <span class="s2">"&lt;YOUR_DB_PASSWORD&gt;"</span><span class="p">,</span>
    <span class="s2">"perms"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"all"</span><span class="p">]</span>
<span class="p">}]</span>
</pre></div>
</div>
<p>Once your servers are set up with rqlite, the first instance must be started normally, and then additional nodes must be added with the “join” command. For instance, here is the first server node:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">p</span> <span class="mi">4001</span><span class="p">:</span><span class="mi">4001</span> <span class="o">-</span><span class="n">p</span> <span class="mi">4002</span><span class="p">:</span><span class="mi">4002</span> <span class="n">rqlite</span><span class="o">/</span><span class="n">rqlite</span> <span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="nb">id</span> <span class="mi">1</span> <span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">addr</span> <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">4001</span> <span class="o">-</span><span class="n">raft</span><span class="o">-</span><span class="n">addr</span> <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">4002</span> <span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">adv</span><span class="o">-</span><span class="n">addr</span> <span class="mf">1.2.3.4</span><span class="p">:</span><span class="mi">4001</span> <span class="o">-</span><span class="n">raft</span><span class="o">-</span><span class="n">adv</span><span class="o">-</span><span class="n">addr</span> <span class="mf">1.2.3.4</span><span class="p">:</span><span class="mi">4002</span> <span class="o">-</span><span class="n">auth</span> <span class="n">config</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>And here is a joining node:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="o">-</span><span class="n">p</span> <span class="mi">4001</span><span class="p">:</span><span class="mi">4001</span> <span class="o">-</span><span class="n">p</span> <span class="mi">4002</span><span class="p">:</span><span class="mi">4002</span> <span class="n">rqlite</span><span class="o">/</span><span class="n">rqlite</span> <span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="nb">id</span> <span class="mi">2</span> <span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">addr</span> <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">4001</span> <span class="o">-</span><span class="n">raft</span><span class="o">-</span><span class="n">addr</span> <span class="mf">0.0.0.0</span><span class="p">:</span><span class="mi">4002</span> <span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">adv</span><span class="o">-</span><span class="n">addr</span> <span class="mf">2.3.4.5</span><span class="p">:</span><span class="mi">4001</span>  <span class="o">-</span><span class="n">raft</span><span class="o">-</span><span class="n">adv</span><span class="o">-</span><span class="n">addr</span> <span class="mf">2.3.4.5</span><span class="p">:</span><span class="mi">4002</span> <span class="o">-</span><span class="n">join</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">netmaker</span><span class="p">:</span><span class="o">&lt;</span><span class="n">YOUR_DB_PASSWORD</span><span class="o">&gt;@</span><span class="mf">1.2.3.4</span><span class="p">:</span><span class="mi">4001</span>
</pre></div>
</div>
<ul class="simple">
<li><p>reference for rqlite setup: <a class="reference external" href="https://github.com/rqlite/rqlite/blob/master/DOC/CLUSTER_MGMT.md#creating-a-cluster">https://github.com/rqlite/rqlite/blob/master/DOC/CLUSTER_MGMT.md#creating-a-cluster</a></p></li>
<li><p>reference for rqlite security: <a class="reference external" href="https://github.com/rqlite/rqlite/blob/master/DOC/SECURITY.md">https://github.com/rqlite/rqlite/blob/master/DOC/SECURITY.md</a></p></li>
</ul>
<p>Once rqlite instances have been configured, the Netmaker servers can be deployed.</p>
</section>
<section id="netmaker-setup">
<h3 id="netmaker-setup">3. Netmaker Setup<a class="headerlink" href="#netmaker-setup" title="Permalink to this headline">¶</a></h3>
<p>Netmaker will be started on each node with default settings, except with DATABASE=rqlite (or DATABASE=postgress) and SQL_CONN set appropriately to reach the local rqlite instance. rqlite will maintain consistency with each Netmaker backend.</p>
<p>If deploying HA with PostgreSQL, you will connect with the following settings:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SQL_HOST</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">sql</span> <span class="n">host</span><span class="o">&gt;</span>
<span class="n">SQL_PORT</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">port</span><span class="o">&gt;</span>
<span class="n">SQL_DB</span>   <span class="o">=</span> <span class="o">&lt;</span><span class="n">designated</span> <span class="n">sql</span> <span class="n">DB</span><span class="o">&gt;</span>
<span class="n">SQL_USER</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">your</span> <span class="n">user</span><span class="o">&gt;</span>
<span class="n">SQL_PASS</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">your</span> <span class="n">password</span><span class="o">&gt;</span>
<span class="n">DATABASE</span> <span class="o">=</span> <span class="n">postgres</span>
</pre></div>
</div>
</section>
<section id="other-considerations">
<h3 id="other-considerations">4. Other Considerations<a class="headerlink" href="#other-considerations" title="Permalink to this headline">¶</a></h3>
<p>This is enough to get a functioning HA installation of Netmaker. However, you may also want to make the Netmaker UI or the CoreDNS server HA as well. The Netmaker UI can simply be added to the same servers and load balanced appropriately. For some load balancers, you may be able to do this with CoreDNS as well.</p>
</section>
</section>
<section id="security-settings">
<h2 id="security-settings">Security Settings<a class="headerlink" href="#security-settings" title="Permalink to this headline">¶</a></h2>
<p>In some cases, it is useful to secure your web dashboard behind a firewall so it can only be accessed in that location. However, you may not want the API behind that firewall so the other nodes can interact with the network without the heightened security. This can be done in Your Caddyfile if you are using caddy.</p>
<section id="for-caddy">
<h3 id="for-caddy">For Caddy<a class="headerlink" href="#for-caddy" title="Permalink to this headline">¶</a></h3>
<p>In your /root/Caddyfile look in the Dashboard section for <code class="docutils literal notranslate"><span class="pre">reverse_proxy</span> <span class="pre">http://netmaker-ui</span></code></p>
<p>Above that line add the following</p>
<div class="highlight-cfg notranslate"><div class="highlight"><pre><span></span><span class="na">@blocked not remote_ip &lt;ip1&gt; &lt;ip2&gt; &lt;ip3&gt;</span><span class="w"></span>
<span class="na">respond @blocked "Nope" 403</span><span class="w"></span>
</pre></div>
</div>
<p>Replace the &lt;ip&gt; placeholders with your whitelist IP ranges.</p>
</section>
<section id="for-traefik">
<h3 id="for-traefik">For Traefik<a class="headerlink" href="#for-traefik" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>In the labels section, add the following line:</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">traefik.http.middlewares.nmui-security-1.ipwhitelist.sourcerange=YOUR_IP_CIDR</span><span class="w"></span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Then look for this line:</p></li>
</ol>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">traefik.http.routers.netmaker-ui.middlewares=nmui-security@docker</span><span class="w"></span>
</pre></div>
</div>
<p>and change it to this:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">traefik.http.routers.netmaker-ui.middlewares=nmui-security-1@docker,nmui-security@docker</span><span class="w"></span>
</pre></div>
</div>
<p>Replace YOUR_IP_CIDR with the whitelist IP range (can be multiple ranges).</p>
<p>After changes are made for your reverse proxy, <code class="docutils literal notranslate"><span class="pre">docker-compose</span> <span class="pre">down</span> <span class="pre">&amp;&amp;</span> <span class="pre">docker-compose</span> <span class="pre">up</span> <span class="pre">-d</span></code> and you should be all set. You can now keep your dashboard secure and your API more available without having to change netmaker-ui ports.</p>
</section>
</section>
</section>


          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="advanced-client-install.html" title="Advanced Client Installation"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> "Previous" </span> Advanced Client Installation </span>
              </div>
            </a>
          
          
            <a href="oauth.html" title="Integrating OAuth"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> "Next" </span> Integrating OAuth </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2023, Netmaker Inc..
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 4.3.2.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>